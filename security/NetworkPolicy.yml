apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: internal-policy
  namespace: default
spec:
  # Apply this policy on pods labeled "name=internal"
  podSelector:
    matchLabels:
      name: internal

  # This policy controls only outbound (egress) traffic
  policyTypes:
  - Egress

  egress:
  # Allow egress traffic from internal pod to MySQL service
  - to:
    - podSelector:
        matchLabels:
          name: mysql
    ports:
    - protocol: TCP
      port: 3306

  # Allow egress traffic from internal pod to Payroll service
  - to:
    - podSelector:
        matchLabels:
          name: payroll
    ports:
    - protocol: TCP
      port: 8080

  # Allow DNS resolution (required for service discovery)
  # Both TCP and UDP are enabled on port 53
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
